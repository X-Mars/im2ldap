import{d as W,r,a as X,q as Y,o as Z,M as ee,c as ae,e as U,B as le,f as l,w as n,k as h,I as se,g as i,C as ne,t as te,N as oe,E as u,n as c,x as T,J as de,O as re,K as ie,L as ue,j as P,_ as ce}from"./index-DyXSoxUy.js";import{l as w}from"./sync--PFXVL9y.js";const _e={class:"ldap-configs-container"},pe={class:"page-header"},fe={class:"dialog-footer"},me=W({__name:"LDAPConfigs",setup(ve){const I=r([]),D=r(!1),x=r(""),N=r("calc(100vh - 180px)"),k=()=>{oe(()=>{const t=document.querySelector(".page-header"),e=t?t.clientHeight:60,d=40;N.value=`calc(100vh - ${e+d+60}px)`})},f=r(!1),m=r(!1),y=r(),q=r(!1),R=r(!1),p=r(!1),v=r(!1),_=r({}),a=X({id:"",server_uri:"",bind_dn:"",bind_password:"",base_dn:"",use_ssl:!1,enabled:!0}),F={server_uri:[{required:!0,message:"请输入服务器URI",trigger:"blur"},{pattern:/^ldaps?:\/\/\S+/,message:"服务器URI格式不正确",trigger:"blur"}],bind_dn:[{required:!0,message:"请输入绑定DN",trigger:"blur"}],base_dn:[{required:!0,message:"请输入基础DN",trigger:"blur"}]},A=()=>{k()},L=async()=>{D.value=!0;try{const t=await w.getConfigs();I.value=t.data,k()}catch(t){console.error("加载LDAP配置失败:",t),u.error("加载LDAP配置失败")}finally{D.value=!1}},H=()=>{a.server_uri!==_.value.server_uri||a.bind_dn!==_.value.bind_dn||a.bind_password!==_.value.bind_password||a.base_dn!==_.value.base_dn||a.use_ssl!==_.value.use_ssl?(p.value=!1,v.value=!0):v.value=!1},$=()=>{m.value=!1,Object.assign(a,{id:"",server_uri:"",bind_dn:"",bind_password:"",base_dn:"",use_ssl:!1,enabled:!0}),_.value={...a},p.value=!1,v.value=!1,f.value=!0},M=t=>{m.value=!0,Object.assign(a,{id:t.id,server_uri:t.server_uri,bind_dn:t.bind_dn,bind_password:"",base_dn:t.base_dn,use_ssl:t.use_ssl,enabled:t.enabled}),_.value={...a},p.value=!1,v.value=!1,f.value=!0},j=t=>{ue.confirm("此操作将永久删除该配置, 是否继续?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await w.deleteConfig(t.id),u.success("删除成功"),L()}catch(e){console.error("删除配置失败:",e),u.error("删除配置失败")}}).catch(()=>{u.info("已取消删除")})},z=async t=>{var e,d;x.value=t.id;try{const o=await w.testConnection(t.id);u.success(o.data.message||"连接成功")}catch(o){console.error("测试连接失败:",o),u.error(((d=(e=o.response)==null?void 0:e.data)==null?void 0:d.message)||"连接失败")}finally{x.value=""}},O=async()=>{y.value&&await y.value.validate(async t=>{var e,d;if(t){R.value=!0;try{let o=a.id;if(m.value&&a.id){const b={...a};b.bind_password||(b.bind_password=void 0),o=(await w.updateConfig(a.id,b)).data.id}else o=(await w.createConfig(a)).data.id,a.id=o,m.value=!0;const C=await w.testConnection(o);u.success(C.data.message||"连接成功"),p.value=!0,v.value=!1,_.value={...a}}catch(o){console.error("测试连接失败:",o),u.error(((d=(e=o.response)==null?void 0:e.data)==null?void 0:d.message)||"连接失败"),p.value=!1}finally{R.value=!1}}})},J=async()=>{!y.value||!p.value||(f.value=!1,u.success(m.value?"更新成功":"创建成功"),L())};return Y(()=>[a.server_uri,a.bind_dn,a.bind_password,a.base_dn,a.use_ssl],()=>{H()},{deep:!0}),Z(()=>{L(),window.addEventListener("resize",A),k()}),ee(()=>{window.removeEventListener("resize",A)}),(t,e)=>{const d=i("el-button"),o=i("el-table-column"),C=i("el-tag"),b=i("el-button-group"),B=i("el-table"),V=i("el-input"),g=i("el-form-item"),E=i("el-switch"),K=i("el-form"),G=i("el-dialog"),Q=ne("loading");return P(),ae("div",_e,[U("div",pe,[e[9]||(e[9]=U("h2",null,"LDAP 配置",-1)),l(d,{type:"primary",onClick:$,icon:h(se)},{default:n(()=>e[8]||(e[8]=[c(" 新增配置 ")])),_:1},8,["icon"])]),le((P(),te(B,{data:I.value,class:"ldap-table",height:N.value},{default:n(()=>[l(o,{prop:"server_uri",label:"服务器URI","min-width":"200"}),l(o,{prop:"bind_dn",label:"绑定DN","min-width":"280"}),l(o,{prop:"base_dn",label:"基础DN","min-width":"180"}),l(o,{label:"SSL","min-width":"100"},{default:n(s=>[l(C,{type:s.row.use_ssl?"success":"info"},{default:n(()=>[c(T(s.row.use_ssl?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(o,{label:"状态","min-width":"100"},{default:n(s=>[l(C,{type:s.row.enabled?"success":"danger"},{default:n(()=>[c(T(s.row.enabled?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),l(o,{label:"操作","min-width":"220",fixed:"right"},{default:n(s=>[l(b,null,{default:n(()=>[l(d,{type:"primary",onClick:S=>M(s.row),icon:h(de)},{default:n(()=>e[10]||(e[10]=[c(" 编辑 ")])),_:2},1032,["onClick","icon"]),l(d,{type:"primary",onClick:S=>z(s.row),loading:x.value===s.row.id,icon:h(re)},{default:n(()=>e[11]||(e[11]=[c(" 测试连接 ")])),_:2},1032,["onClick","loading","icon"]),l(d,{type:"danger",onClick:S=>j(s.row),icon:h(ie)},{default:n(()=>e[12]||(e[12]=[c(" 删除 ")])),_:2},1032,["onClick","icon"])]),_:2},1024)]),_:1})]),_:1},8,["data","height"])),[[Q,D.value]]),l(G,{modelValue:f.value,"onUpdate:modelValue":e[7]||(e[7]=s=>f.value=s),title:m.value?"编辑LDAP配置":"新增LDAP配置",width:"600px"},{footer:n(()=>[U("span",fe,[l(d,{onClick:e[6]||(e[6]=s=>f.value=!1)},{default:n(()=>e[13]||(e[13]=[c("取消")])),_:1}),l(d,{type:"primary",onClick:O,loading:R.value,disabled:!v.value},{default:n(()=>e[14]||(e[14]=[c(" 测试连接 ")])),_:1},8,["loading","disabled"]),l(d,{type:"success",onClick:J,loading:q.value,disabled:!p.value},{default:n(()=>e[15]||(e[15]=[c(" 保存 ")])),_:1},8,["loading","disabled"])])]),default:n(()=>[l(K,{model:a,"label-width":"120px",rules:F,ref_key:"formRef",ref:y},{default:n(()=>[l(g,{label:"服务器URI",prop:"server_uri"},{default:n(()=>[l(V,{modelValue:a.server_uri,"onUpdate:modelValue":e[0]||(e[0]=s=>a.server_uri=s),placeholder:"例如: ldap://example.com:389",value:"ldap://localhost:389"},null,8,["modelValue"])]),_:1}),l(g,{label:"绑定DN",prop:"bind_dn"},{default:n(()=>[l(V,{modelValue:a.bind_dn,"onUpdate:modelValue":e[1]||(e[1]=s=>a.bind_dn=s),placeholder:"例如: cn=admin,dc=example,dc=com"},null,8,["modelValue"])]),_:1}),l(g,{label:"绑定密码",prop:"bind_password"},{default:n(()=>[l(V,{modelValue:a.bind_password,"onUpdate:modelValue":e[2]||(e[2]=s=>a.bind_password=s),type:"password",placeholder:"请输入绑定密码","show-password":""},null,8,["modelValue"])]),_:1}),l(g,{label:"基础DN",prop:"base_dn"},{default:n(()=>[l(V,{modelValue:a.base_dn,"onUpdate:modelValue":e[3]||(e[3]=s=>a.base_dn=s),placeholder:"例如: dc=example,dc=com"},null,8,["modelValue"])]),_:1}),l(g,{label:"启用SSL"},{default:n(()=>[l(E,{modelValue:a.use_ssl,"onUpdate:modelValue":e[4]||(e[4]=s=>a.use_ssl=s)},null,8,["modelValue"])]),_:1}),l(g,{label:"启用"},{default:n(()=>[l(E,{modelValue:a.enabled,"onUpdate:modelValue":e[5]||(e[5]=s=>a.enabled=s)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),we=ce(me,[["__scopeId","data-v-d85e6a76"]]);export{we as default};
