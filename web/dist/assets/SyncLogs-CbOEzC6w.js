import{d as H,r as D,a as T,o as O,c as i,e as l,B as P,f as n,w as s,g as f,k as G,P as K,C as q,t as M,E as I,F as w,s as C,n as x,x as d,G as J,j as r,_ as Q}from"./index-DyXSoxUy.js";import{b as W,s as X}from"./sync--PFXVL9y.js";const Z={class:"sync-logs-container"},$={class:"page-header"},ee={class:"filter-section"},ae={class:"expand-container"},te={key:0,class:"change-content"},ne={key:0,class:"change-item-container"},oe={class:"change-key"},le={class:"change-value new-value"},se={key:1,class:"change-item-container"},re={class:"change-key"},ce={class:"change-value old-value"},ie={key:2,class:"change-item-container"},de={class:"change-key"},ue={class:"change-comparison"},pe={class:"change-value old-value"},_e={class:"change-value new-value"},ge={key:1},me={class:"pagination"},fe=H({__name:"SyncLogs",setup(ye){const z=D([]),V=D([]),k=D(!1),_=T({current:1,size:20,total:0}),o=T({config:"",dateRange:[],objectType:"",action:""}),R=t=>J(t).format("YYYY-MM-DD HH:mm:ss"),S=t=>{const e=V.value.find(u=>u.id===t);return e?e.name:t},L=t=>{const e={};if(t.action==="create"||t.action==="delete")return e;const u=t.old_data||{},y=t.new_data||{},j=[...new Set([...Object.keys(u),...Object.keys(y)])];for(const v of j){const c=u[v],b=y[v];c!==b&&(e[v]={old:c,new:b})}return e},g=async()=>{k.value=!0;try{const t={page:_.current,page_size:_.size};o.config&&(t.config=o.config),o.dateRange&&o.dateRange.length===2&&(t.start_date=o.dateRange[0],t.end_date=o.dateRange[1]),o.objectType&&(t.object_type=o.objectType),o.action&&(t.action=o.action);const e=await W.getLogs(t);z.value=e.data.results||e.data,_.total=e.data.count||e.data.length}catch(t){console.error("加载同步日志失败:",t),I.error("加载同步日志失败")}finally{k.value=!1}},U=async()=>{try{const t=await X.getConfigs();V.value=t.data}catch(t){console.error("加载同步配置失败:",t)}},B=t=>({create:"success",update:"warning",delete:"danger",move:"info"})[t]||"",A=()=>{_.current=1,g()},N=()=>{g()};return O(()=>{U(),g()}),(t,e)=>{const u=f("el-option"),y=f("el-select"),j=f("el-date-picker"),v=f("el-button"),c=f("el-table-column"),b=f("el-tag"),Y=f("el-table"),E=f("el-pagination"),F=q("loading");return r(),i("div",Z,[l("div",$,[e[7]||(e[7]=l("h2",null,"同步日志",-1)),l("div",ee,[n(y,{modelValue:o.config,"onUpdate:modelValue":e[0]||(e[0]=a=>o.config=a),placeholder:"选择配置",clearable:"",onChange:g,style:{width:"150px","margin-right":"10px"}},{default:s(()=>[(r(!0),i(w,null,C(V.value,a=>(r(),M(u,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),n(j,{modelValue:o.dateRange,"onUpdate:modelValue":e[1]||(e[1]=a=>o.dateRange=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:g,style:{width:"260px","margin-right":"10px"}},null,8,["modelValue"]),n(y,{modelValue:o.objectType,"onUpdate:modelValue":e[2]||(e[2]=a=>o.objectType=a),placeholder:"对象类型",clearable:"",onChange:g,style:{width:"120px","margin-right":"10px"}},{default:s(()=>[n(u,{label:"用户",value:"user"}),n(u,{label:"部门",value:"department"})]),_:1},8,["modelValue"]),n(y,{modelValue:o.action,"onUpdate:modelValue":e[3]||(e[3]=a=>o.action=a),placeholder:"操作类型",clearable:"",onChange:g,style:{width:"120px","margin-right":"10px"}},{default:s(()=>[n(u,{label:"创建",value:"create"}),n(u,{label:"更新",value:"update"}),n(u,{label:"删除",value:"delete"}),n(u,{label:"移动",value:"move"})]),_:1},8,["modelValue"]),n(v,{type:"primary",onClick:g,icon:G(K)},{default:s(()=>e[6]||(e[6]=[x(" 搜索 ")])),_:1},8,["icon"])])]),P((r(),M(Y,{data:z.value,style:{width:"100%"}},{default:s(()=>[n(c,{type:"expand"},{default:s(a=>[l("div",ae,[n(Y,{data:a.row.details||[],style:{width:"100%"}},{default:s(()=>[n(c,{prop:"object_type_display",label:"对象类型"}),n(c,{prop:"action_display",label:"操作类型"},{default:s(p=>[n(b,{type:B(p.row.action),effect:"plain"},{default:s(()=>[x(d(p.row.action_display),1)]),_:2},1032,["type"])]),_:1}),n(c,{prop:"object_name",label:"对象名称"}),n(c,{prop:"details",label:"详情描述","min-width":"200"}),n(c,{label:"变更内容","min-width":"250"},{default:s(p=>[p.row.old_data||p.row.new_data?(r(),i("div",te,[p.row.action==="create"?(r(),i("div",ne,[(r(!0),i(w,null,C(p.row.new_data,(h,m)=>(r(),i("div",{key:m,class:"change-item"},[l("span",oe,d(m)+":",1),l("span",le,d(h),1)]))),128))])):p.row.action==="delete"?(r(),i("div",se,[(r(!0),i(w,null,C(p.row.old_data,(h,m)=>(r(),i("div",{key:m,class:"change-item"},[l("span",re,d(m)+":",1),l("span",ce,d(h),1)]))),128))])):(r(),i("div",ie,[(r(!0),i(w,null,C(L(p.row),(h,m)=>(r(),i("div",{key:m,class:"change-item"},[l("span",de,d(m)+":",1),l("div",ue,[l("span",pe,d(h.old||"-"),1),e[8]||(e[8]=l("span",{class:"arrow"},"→",-1)),l("span",_e,d(h.new||"-"),1)])]))),128))]))])):(r(),i("span",ge,"无变更数据"))]),_:1})]),_:2},1032,["data"])])]),_:1}),n(c,{label:"配置名称"},{default:s(a=>[l("span",null,d(S(a.row.config)),1)]),_:1}),n(c,{prop:"sync_time",label:"同步时间"},{default:s(a=>[x(d(R(a.row.sync_time)),1)]),_:1}),n(c,{label:"同步结果"},{default:s(a=>[n(b,{type:a.row.success?"success":"danger"},{default:s(()=>[x(d(a.row.success?"成功":"失败"),1)]),_:2},1032,["type"])]),_:1}),n(c,{label:"同步数据"},{default:s(a=>[l("div",null," 用户: "+d(a.row.users_synced),1),l("div",null," 部门: "+d(a.row.departments_synced),1)]),_:1})]),_:1},8,["data"])),[[F,k.value]]),l("div",me,[n(E,{"current-page":_.current,"onUpdate:currentPage":e[4]||(e[4]=a=>_.current=a),"page-size":_.size,"onUpdate:pageSize":e[5]||(e[5]=a=>_.size=a),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:_.total,onSizeChange:A,onCurrentChange:N},null,8,["current-page","page-size","total"])])])}}}),be=Q(fe,[["__scopeId","data-v-18c926e9"]]);export{be as default};
