import{d as te,r as c,a as le,o as ne,c as k,e as g,B as ae,f as n,w as a,k as D,I as se,g as r,C as oe,t as f,E as i,n as o,x,J as re,D as ue,K as de,A as P,F as ie,s as me,G as pe,L as ce,j as d,_ as fe}from"./index-DyXSoxUy.js";import{s as v,c as _e,l as ye}from"./sync--PFXVL9y.js";const ge={class:"sync-configs-container"},be={class:"page-header"},ve={style:{"margin-top":"5px"}},we={key:0},Ve={key:1},Ce={class:"dialog-footer"},ke=te({__name:"SyncConfigs",setup(De){const T=c([]),w=c([]),U=c(!1),q=c(""),y=c(!1),b=c(!1),M=c(),A=c(!1),s=le({id:"",name:"",sync_type:"wecom",ldap_config:"",sync_users:!0,sync_departments:!0,user_ou:"users",department_ou:"departments",sync_frequency:"manual",enabled:!0}),E={name:[{required:!0,message:"请输入配置名称",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],sync_type:[{required:!0,message:"请选择同步类型",trigger:"change"}],ldap_config:[{required:!0,message:"请选择LDAP配置",trigger:"change"}],user_ou:[{required:!0,message:"请输入用户OU",trigger:"blur"}],department_ou:[{required:!0,message:"请输入部门OU",trigger:"blur"}],sync_frequency:[{required:!0,message:"请选择同步频率",trigger:"change"}]},F=t=>({wecom:"企业微信",feishu:"飞书",dingtalk:"钉钉"})[t]||t,j=t=>({wecom:"primary",feishu:"success",dingtalk:"warning"})[t]||"info",z=t=>t<300?"每"+t+"秒":t<3600?"每"+Math.floor(t/60)+"分钟":t<86400?"每"+Math.floor(t/3600)+"小时":"每"+Math.floor(t/86400)+"天",Y=t=>t<300?"danger":t<3600?"warning":t<86400?"success":"primary",$=t=>pe(t).format("YYYY-MM-DD HH:mm:ss"),V=async()=>{U.value=!0;try{const t=await v.getConfigs();T.value=t.data}catch(t){console.error("加载同步配置失败:",t),i.error("加载同步配置失败")}finally{U.value=!1}},B=async()=>{try{const t=await ye.getConfigs();w.value=t.data.filter(e=>e.enabled)}catch(t){console.error("加载LDAP配置失败:",t),i.error("加载LDAP配置失败")}},I=async()=>{if(await B(),w.value.length===0){i.warning("请先添加LDAP配置");return}b.value=!1,Object.assign(s,{id:"",name:"",sync_type:"wecom",ldap_config:w.value[0].id,sync_users:!0,sync_departments:!0,user_ou:"users",department_ou:"departments",sync_frequency:"manual",enabled:!0}),y.value=!0},R=async t=>{await B(),b.value=!0,Object.assign(s,{id:t.id,name:t.name,sync_type:t.sync_type,ldap_config:t.ldap_config,sync_users:t.sync_users,sync_departments:t.sync_departments,user_ou:t.user_ou,department_ou:t.department_ou,sync_frequency:t.sync_frequency,enabled:t.enabled}),y.value=!0},H=t=>{ce.confirm("此操作将永久删除该配置, 是否继续?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await v.deleteConfig(t.id),i.success("删除成功"),V()}catch(e){console.error("删除配置失败:",e),i.error("删除配置失败")}}).catch(()=>{i.info("已取消删除")})},G=async t=>{var e,m;q.value=t.id;try{const u=await v.syncNow(t.id);i.success(u.data.message||"同步成功"),V()}catch(u){console.error("同步失败:",u),i.error(((m=(e=u.response)==null?void 0:e.data)==null?void 0:m.message)||"同步失败")}finally{q.value=""}},J=async()=>{M.value&&await M.value.validate(async t=>{if(t){A.value=!0;try{const e=_e(s);b.value?(await v.updateConfig(s.id,e),i.success("更新成功")):(await v.createConfig(e),i.success("创建成功")),y.value=!1,V()}catch(e){console.error("保存配置失败:",e),i.error("保存配置失败")}finally{A.value=!1}}})};return ne(()=>{V()}),(t,e)=>{const m=r("el-button"),u=r("el-table-column"),_=r("el-tag"),K=r("el-button-group"),h=r("el-table"),L=r("el-input"),p=r("el-form-item"),C=r("el-option"),N=r("el-select"),O=r("el-checkbox"),Q=r("el-input-number"),W=r("el-switch"),X=r("el-form"),Z=r("el-dialog"),ee=oe("loading");return d(),k("div",ge,[g("div",be,[e[12]||(e[12]=g("h2",null,"同步配置",-1)),n(m,{type:"primary",onClick:I,icon:D(se)},{default:a(()=>e[11]||(e[11]=[o(" 新增配置 ")])),_:1},8,["icon"])]),ae((d(),f(h,{data:T.value,style:{width:"100%"}},{default:a(()=>[n(u,{prop:"name",label:"配置名称"}),n(u,{label:"同步类型"},{default:a(l=>[n(_,{type:j(l.row.sync_type)},{default:a(()=>[o(x(F(l.row.sync_type)),1)]),_:2},1032,["type"])]),_:1}),n(u,{label:"同步范围"},{default:a(l=>[g("div",null,[l.row.sync_users?(d(),f(_,{key:0,type:"success",size:"small"},{default:a(()=>e[13]||(e[13]=[o("用户")])),_:1})):(d(),f(_,{key:1,type:"info",size:"small"},{default:a(()=>e[14]||(e[14]=[o("不同步用户")])),_:1}))]),g("div",ve,[l.row.sync_departments?(d(),f(_,{key:0,type:"success",size:"small"},{default:a(()=>e[15]||(e[15]=[o("部门")])),_:1})):(d(),f(_,{key:1,type:"info",size:"small"},{default:a(()=>e[16]||(e[16]=[o("不同步部门")])),_:1}))])]),_:1}),n(u,{label:"同步频率"},{default:a(l=>[n(_,{type:Y(l.row.sync_interval)},{default:a(()=>[o(x(z(l.row.sync_interval)),1)]),_:2},1032,["type"])]),_:1}),n(u,{label:"上次同步"},{default:a(l=>[l.row.last_sync_time?(d(),k("span",we,x($(l.row.last_sync_time)),1)):(d(),k("span",Ve,"从未同步"))]),_:1}),n(u,{label:"状态"},{default:a(l=>[n(_,{type:l.row.enabled?"success":"danger"},{default:a(()=>[o(x(l.row.enabled?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),n(u,{label:"操作"},{default:a(l=>[n(K,null,{default:a(()=>[n(m,{type:"primary",onClick:S=>R(l.row),icon:D(re)},{default:a(()=>e[17]||(e[17]=[o(" 编辑 ")])),_:2},1032,["onClick","icon"]),n(m,{type:"primary",onClick:S=>G(l.row),loading:q.value===l.row.id,icon:D(ue)},{default:a(()=>e[18]||(e[18]=[o(" 同步 ")])),_:2},1032,["onClick","loading","icon"]),n(m,{type:"danger",onClick:S=>H(l.row),icon:D(de)},{default:a(()=>e[19]||(e[19]=[o(" 删除 ")])),_:2},1032,["onClick","icon"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[ee,U.value]]),n(Z,{modelValue:y.value,"onUpdate:modelValue":e[10]||(e[10]=l=>y.value=l),title:b.value?"编辑同步配置":"新增同步配置",width:"600px"},{footer:a(()=>[g("span",Ce,[n(m,{onClick:e[9]||(e[9]=l=>y.value=!1)},{default:a(()=>e[23]||(e[23]=[o("取消")])),_:1}),n(m,{type:"primary",onClick:J,loading:A.value},{default:a(()=>e[24]||(e[24]=[o(" 保存 ")])),_:1},8,["loading"])])]),default:a(()=>[n(X,{model:s,"label-width":"120px",rules:E,ref_key:"formRef",ref:M},{default:a(()=>[n(p,{label:"配置名称",prop:"name"},{default:a(()=>[n(L,{modelValue:s.name,"onUpdate:modelValue":e[0]||(e[0]=l=>s.name=l),placeholder:"请输入配置名称"},null,8,["modelValue"])]),_:1}),n(p,{label:"同步类型",prop:"sync_type"},{default:a(()=>[n(N,{modelValue:s.sync_type,"onUpdate:modelValue":e[1]||(e[1]=l=>s.sync_type=l),placeholder:"请选择同步类型",style:{width:"100%"},disabled:b.value},{default:a(()=>[n(C,{label:"企业微信",value:"wecom"}),n(C,{label:"飞书",value:"feishu"}),n(C,{label:"钉钉",value:"dingtalk"})]),_:1},8,["modelValue","disabled"])]),_:1}),n(p,{label:"LDAP配置",prop:"ldap_config"},{default:a(()=>[n(N,{modelValue:s.ldap_config,"onUpdate:modelValue":e[2]||(e[2]=l=>s.ldap_config=l),placeholder:"请选择LDAP配置",style:{width:"100%"}},{default:a(()=>[(d(!0),k(ie,null,me(w.value,l=>(d(),f(C,{key:l.id,label:l.server_uri,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),n(p,{label:"同步范围"},{default:a(()=>[n(O,{modelValue:s.sync_users,"onUpdate:modelValue":e[3]||(e[3]=l=>s.sync_users=l)},{default:a(()=>e[20]||(e[20]=[o("同步用户")])),_:1},8,["modelValue"]),n(O,{modelValue:s.sync_departments,"onUpdate:modelValue":e[4]||(e[4]=l=>s.sync_departments=l)},{default:a(()=>e[21]||(e[21]=[o("同步部门")])),_:1},8,["modelValue"])]),_:1}),s.sync_users?(d(),f(p,{key:0,label:"用户OU",prop:"user_ou"},{default:a(()=>[n(L,{modelValue:s.user_ou,"onUpdate:modelValue":e[5]||(e[5]=l=>s.user_ou=l),placeholder:"用户OU，例如：users"},null,8,["modelValue"])]),_:1})):P("",!0),s.sync_departments?(d(),f(p,{key:1,label:"部门OU",prop:"department_ou"},{default:a(()=>[n(L,{modelValue:s.department_ou,"onUpdate:modelValue":e[6]||(e[6]=l=>s.department_ou=l),placeholder:"部门OU，例如：departments"},null,8,["modelValue"])]),_:1})):P("",!0),n(p,{label:"同步间隔(秒)",prop:"sync_interval"},{default:a(()=>[n(Q,{modelValue:s.sync_interval,"onUpdate:modelValue":e[7]||(e[7]=l=>s.sync_interval=l),min:60,max:86400,step:60,style:{width:"100%"},placeholder:"请输入同步间隔秒数"},null,8,["modelValue"]),e[22]||(e[22]=g("div",{class:"form-item-tip"},"最小60秒，最大86400秒(24小时)",-1))]),_:1}),n(p,{label:"启用"},{default:a(()=>[n(W,{modelValue:s.enabled,"onUpdate:modelValue":e[8]||(e[8]=l=>s.enabled=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),qe=fe(ke,[["__scopeId","data-v-a1c0da38"]]);export{qe as default};
